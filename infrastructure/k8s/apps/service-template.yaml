apiVersion: v1
kind: Service
metadata:
  name: service-template
  labels:
    app: service-template
spec:
  ports:
    - port: 3001
      targetPort: 3000
      name: http
  selector:
    app: service-template
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: service-template
spec:
  serviceName: service-template
  replicas: 1
  selector:
    matchLabels:
      app: service-template
  template:
    metadata:
      labels:
        app: service-template
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "service-template-role"
        vault.hashicorp.com/agent-inject-secret-config: "secret/data/app/service-template"
        vault.hashicorp.com/agent-inject-template-config: |
          {{- with secret "secret/data/app/service-template" -}}
            export DB_PATH="/data/service-template.db"
            export API_PORT="3000"
            export SERVICE_NAME="service-template"
            {{- range $k, $v := .Data.data }}
            export {{ $k | toUpper }}={{ $v | toJSON }}
            {{- end }}
          {{- end -}}
    spec:
      serviceAccountName: service-template
      
      # SÉCURITÉ : fsGroup configure automatiquement les droits du volume /data
      # L'utilisateur 1000 (node) pourra lire et écrire dedans.
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000

      # --- INIT CONTAINER SUPPRIMÉ ---

      containers:
        - name: service-template
          image: service-template:latest
          imagePullPolicy: Never
          ports:
            - containerPort: 3000
          command: ["/bin/sh", "-c"]
          # Chargement des secrets puis lancement de l'application
          args: [". /vault/secrets/config && node apps/service-template/dist/main.js"]
          
          volumeMounts:
            - name: data-volume
              mountPath: /data
          
          # Vérifie que l'API répond et que la DB est connectée
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 15
          
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5

  volumeClaimTemplates:
    - metadata:
        name: data-volume
      spec:
        accessModes: [ "ReadWriteOnce" ]
        storageClassName: "local-path"
        resources:
          requests:
            storage: 100Mi
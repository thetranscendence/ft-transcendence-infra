apiVersion: batch/v1
kind: Job
metadata:
  name: init-es-users
  labels:
    app: elasticsearch-init
    component: security-setup
spec:
  # Nettoyage automatique : Le Pod est supprimé 60s après la réussite du script
  # pour ne pas laisser de secrets traîner en mémoire inutilement.
  ttlSecondsAfterFinished: 60
  
  template:
    metadata:
      annotations:
        # ======================================================================
        # CONFIGURATION DE L'INJECTION VAULT (Zero Trust)
        # ======================================================================
        # Active l'agent Vault Sidecar pour ce Job
        vault.hashicorp.com/agent-inject: "true"
        
        # Mode "Pre-Populate" : L'agent récupère les secrets, écrit les fichiers,
        # puis s'arrête. Idéal pour les Jobs qui n'ont pas besoin de renouvellement.
        vault.hashicorp.com/agent-pre-populate-only: "true"
        
        # RÔLE PRIVILÉGIÉ :
        # On utilise ici un rôle spécifique "elastic-admin-init-role".
        # C'est le SEUL composant autorisé à accéder simultanément :
        # 1. Au mot de passe Root "elastic" (pour s'authentifier en Admin)
        # 2. Au secret "kibana" (pour définir le mot de passe cible)
        # 3. Au secret "logstash" (pour définir le mot de passe cible)
        vault.hashicorp.com/role: "elastic-admin-init-role"

        # --- SECRET 1 : Identifiants Admin (Source) ---
        vault.hashicorp.com/agent-inject-secret-elastic: "secret/data/infra/elastic"
        vault.hashicorp.com/agent-inject-template-elastic: |
          {{- with secret "secret/data/infra/elastic" -}}
            export ELASTIC_PASSWORD={{ .Data.data.password | toJSON }}
          {{- end -}}

        # --- SECRET 2 : Identifiants Kibana System (Cible) ---
        vault.hashicorp.com/agent-inject-secret-kibana: "secret/data/infra/kibana"
        vault.hashicorp.com/agent-inject-template-kibana: |
          {{- with secret "secret/data/infra/kibana" -}}
            export KIBANA_SYSTEM_PASSWORD={{ .Data.data.password | toJSON }}
          {{- end -}}

        # --- SECRET 3 : Identifiants Logstash Writer (Cible) ---
        vault.hashicorp.com/agent-inject-secret-logstash: "secret/data/infra/logstash"
        vault.hashicorp.com/agent-inject-template-logstash: |
          {{- with secret "secret/data/infra/logstash" -}}
            # On récupère le nom d'utilisateur dynamique stocké dans Vault
            export LOGSTASH_USER={{ .Data.data.username | toJSON }}
            export LOGSTASH_PASSWORD={{ .Data.data.password | toJSON }}
          {{- end -}}

    spec:
      # Identité Kubernetes liée au rôle Vault "elastic-admin-init-role"
      serviceAccountName: elastic-admin-init
      
      restartPolicy: OnFailure
      
      containers:
      - name: init-users
        # Image légère contenant 'curl' pour interagir avec l'API Elasticsearch
        image: curlimages/curl:latest
        
        # Exécution du script monté depuis la ConfigMap.
        # Le script va sourcer les secrets injectés par Vault avant de lancer les appels API.
        command: ["/bin/sh", "/scripts/init_users.sh"]

        volumeMounts:
          # Montage du dossier contenant les scripts (init + logger)
          - name: scripts-vol
            mountPath: /scripts
            readOnly: true
      
      volumes:
        # Source : ConfigMap générée par le Makefile (cible deploy-services)
        - name: scripts-vol
          configMap:
            name: es-init-scripts
            defaultMode: 0755 # Garantit que les scripts sont exécutables